# 指数对比功能说明

## 功能概述

在前端可视化系统中，现在可以在多个页面添加常用指数的对比曲线，帮助用户更好地评估股票或AI Agent的表现。

## 支持的指数

系统内置了以下常用A股指数：

| 代码 | 名称 | 说明 |
|------|------|------|
| sh.000001 | 上证指数 | 上海证券综合指数 |
| sz.399001 | 深证成指 | 深圳成份指数 |
| sz.399006 | 创业板指 | 创业板指数 |
| sh.000300 | 沪深300 | 沪深300指数 |
| sh.000016 | 上证50 | 上证50指数 |
| sh.000905 | 中证500 | 中证500指数 |
| sz.399673 | 创业板50 | 创业板50指数 |

**注意**：指数代码使用 `sh.` 或 `sz.` 前缀来区分市场，避免与股票代码冲突（如上证指数sh.000001 vs 平安银行000001）。

## 功能使用

### 1. 股票详细分析页面

**位置**：📈 股票详细分析

**使用方法**：
1. 选择要分析的股票
2. 选择时间范围
3. 展开"📊 添加指数对比（可选）"面板
4. 选择一个或多个指数
5. 选择"收益率分析"图表类型
6. 查看股票与指数的归一化收益率对比

**图表特点**：
- 所有曲线归一化到起始日期（起始值设为0%）
- 股票曲线为实线，指数曲线为虚线
- 可直观比较股票与大盘的相对表现

### 2. 多股票对比页面

**位置**：🔍 多股票对比

**使用方法**：
1. 选择2-10只股票进行对比
2. 选择时间范围
3. 在"📊 添加指数对比"部分选择指数
4. 查看所有股票与指数的归一化对比图

**图表特点**：
- 归一化显示，方便对比不同价格区间的股票
- 指数以虚线样式显示，与股票曲线区分
- 支持同时对比多个指数

### 3. AI Agent交易结果页面

**位置**：💻 AI Agent交易结果

**使用方法**：
1. 选择要查看的AI Agent交易日志
2. 在左侧边栏"📊 指数对比设置"中选择指数
3. 选择"💰 资产曲线"视图
4. 查看投资组合收益率与指数的对比

**图表特点**：
- 投资组合和指数都归一化为收益率（%）
- 可以直观看出AI策略是否跑赢大盘
- 零轴参考线帮助判断盈亏

**支持视图**：
- **💰 资产曲线**：显示投资组合收益率与指数的对比
- **📈 综合概览**：在收益率变化子图中显示指数对比

## 技术实现

### 新增函数

#### visualization/charts.py
```python
def add_index_to_comparison(fig, index_data_dict, index_names)
    """向对比图表中添加指数曲线"""

def create_comparison_with_index(data_dict, index_data_dict, index_names, title)
    """创建包含指数的多股票对比图"""
```

#### visualization/agent_charts.py
```python
def create_portfolio_value_chart_with_index(df, index_data_dict, index_names, title)
    """创建带指数对比的投资组合总资产变化曲线图"""
```

### 数据归一化

所有对比图表都使用归一化处理：
```python
normalized = (close_price / initial_price - 1) * 100
```
这样可以：
- 统一不同价格区间的股票/指数
- 直观显示收益率百分比
- 方便横向对比表现

## 注意事项

1. **数据完整性**：确保数据库中有对应指数的历史数据
2. **日期匹配**：指数数据会自动匹配所选股票的日期范围
3. **性能优化**：建议一次不要选择过多指数（1-3个为宜）
4. **缓存机制**：数据查询已启用缓存，重复查询速度更快

## 使用场景

### 场景1：评估个股表现
- 选择一只股票
- 添加相关指数（如所属板块指数）
- 查看是否跑赢/跑输大盘

### 场景2：板块轮动分析
- 选择多只不同板块的股票
- 添加大盘指数
- 对比各板块的相对强弱

### 场景3：AI策略评估
- 查看AI Agent的交易结果
- 添加基准指数
- 评估策略是否具有超额收益

## 后续优化方向

1. 支持自定义指数代码输入
2. 添加更多技术指标的对比
3. 支持导出对比数据
4. 添加统计分析（如相关系数、Beta系数等）
