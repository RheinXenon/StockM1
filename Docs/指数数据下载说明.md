# A股指数数据下载说明

## 概述

本文档说明如何在数据库中下载和存储A股常用指数的历史数据。

## ⚠️ 重要：指数代码冲突处理

为避免指数代码与股票代码冲突（例如：000001既是上证指数也是平安银行的股票代码），系统在存储指数数据时会**自动添加99前缀**：

- **下载时使用原始代码**：000001, 399001 等
- **数据库存储代码**：99000001, 99399001 等
- **查询时**：使用 `db.get_index_data('000001')` 会自动处理前缀

## 指数代码说明

A股指数使用特殊的代码标识，与普通股票代码不同：

### 上证指数系列（市场代码：sh）
| 指数代码 | 指数名称 | 说明 |
|---------|---------|------|
| 000001  | 上证指数 | 上海证券交易所综合指数 |
| 000016  | 上证50   | 上海市场市值最大的50只股票 |
| 000300  | 沪深300  | 沪深两市市值最大的300只股票 |
| 000905  | 中证500  | 中等市值的500只股票 |
| 000688  | 科创50   | 科创板市值最大的50只股票 |

### 深证指数系列（市场代码：sz）
| 指数代码 | 指数名称 | 说明 |
|---------|---------|------|
| 399001  | 深证成指 | 深圳证券交易所成份指数 |
| 399006  | 创业板指 | 创业板综合指数 |
| 399005  | 中小板指 | 中小板综合指数 |

## 下载方式

### 方式一：使用独立脚本（推荐）

运行项目根目录下的 `download_indices.py` 脚本：

```bash
python download_indices.py
```

该脚本会：
1. 显示将要下载的所有指数列表
2. 询问用户确认
3. 下载从2015年至今的所有指数数据
4. 自动保存到数据库
5. 显示下载统计和数据库统计

**优点：**
- 有友好的交互界面
- 显示详细的下载进度
- 自动显示统计信息
- 易于查看结果

### 方式二：使用CLI命令

```bash
python -m src.stock_app.cli download-indices --start-date 20150101
```

**参数说明：**
- `--start-date`: 开始日期（格式：YYYYMMDD），默认：20100101
- `--end-date`: 结束日期（格式：YYYYMMDD），默认：今天

**示例：**
```bash
# 下载2015年至今的指数数据
python -m src.stock_app.cli download-indices --start-date 20150101

# 下载2020年至2023年的指数数据
python -m src.stock_app.cli download-indices --start-date 20200101 --end-date 20231231
```

## 数据存储

指数数据存储在 SQLite 数据库的 `index_daily` 表中：

```sql
CREATE TABLE index_daily (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    symbol TEXT NOT NULL,      -- 指数代码（存储时带99前缀，如：99000001, 99399001）
    date TEXT NOT NULL,         -- 交易日期
    open REAL,                  -- 开盘点位
    close REAL,                 -- 收盘点位
    high REAL,                  -- 最高点位
    low REAL,                   -- 最低点位
    volume REAL,                -- 成交量
    UNIQUE(symbol, date)
);
```

**注意**：symbol 字段存储的是添加了99前缀的代码，例如：
- 上证指数（000001）存储为：**99000001**
- 深证成指（399001）存储为：**99399001**

## 查询指数数据

### 使用Python代码查询（推荐）

**方法1：使用封装的接口（推荐，自动处理前缀）**

```python
from src.stock_app.database import Database

# 连接数据库
db = Database()

# 查询上证指数（000001）的数据 - 自动添加99前缀
df = db.get_index_data('000001', start_date='2023-01-01', end_date='2023-12-31')
print(df)

# 查询深证成指
df_sz = db.get_index_data('399001')
print(df_sz)
```

**方法2：直接使用SQL查询（需要手动添加99前缀）**

```python
from src.stock_app.database import Database
import pandas as pd

db = Database()
conn = db.connect()

# 查询上证指数 - 注意：需要使用99000001
query = """
    SELECT * FROM index_daily
    WHERE symbol = '99000001'
    ORDER BY date DESC
    LIMIT 10
"""
df = pd.read_sql_query(query, conn)
print(df)

# 查询所有指数的统计信息
stats_query = """
    SELECT 
        symbol,
        COUNT(*) as record_count,
        MIN(date) as start_date,
        MAX(date) as end_date
    FROM index_daily
    GROUP BY symbol
    ORDER BY symbol
"""
stats = pd.read_sql_query(stats_query, conn)
print(stats)
```

### 使用SQL直接查询

**注意：SQL查询时必须使用带99前缀的存储代码**

```sql
-- 查询上证指数（99000001）最近10个交易日
SELECT * FROM index_daily 
WHERE symbol = '99000001' 
ORDER BY date DESC 
LIMIT 10;

-- 查询深证成指（99399001）
SELECT * FROM index_daily 
WHERE symbol = '99399001' 
ORDER BY date DESC 
LIMIT 10;

-- 查询2023年所有指数的平均涨跌幅
SELECT 
    symbol,
    AVG((close - open) / open * 100) as avg_change_pct
FROM index_daily
WHERE date LIKE '2023-%'
GROUP BY symbol;

-- 查询各指数数据完整度
SELECT 
    symbol,
    COUNT(*) as days,
    MIN(date) as first_date,
    MAX(date) as last_date
FROM index_daily
GROUP BY symbol;

-- 代码对照表
-- 原始代码 -> 存储代码
-- 000001 (上证指数) -> 99000001
-- 000016 (上证50)   -> 99000016
-- 000300 (沪深300)  -> 99000300
-- 000905 (中证500)  -> 99000905
-- 000688 (科创50)   -> 99000688
-- 399001 (深证成指) -> 99399001
-- 399006 (创业板指) -> 99399006
-- 399005 (中小板指) -> 99399005
```

## 注意事项

1. **网络要求**：需要能够访问 akshare 的数据源
2. **时间范围**：建议从2015年开始下载，与股票数据保持一致
3. **更新频率**：建议每日收盘后更新一次
4. **存储空间**：8个指数从2015年至今约需要20-30MB空间
5. **下载时间**：首次下载约需1-3分钟

## 常见问题

### Q1: 下载失败怎么办？
A: 检查网络连接，确保可以访问数据源。如果某个指数下载失败，脚本会跳过并继续下载其他指数。

### Q2: 如何更新指数数据？
A: 重新运行下载脚本即可。数据库使用 `INSERT OR REPLACE` 策略，会自动更新已存在的数据。

### Q3: 可以只下载特定指数吗？
A: 可以。修改 `download_indices.py` 或 `src/stock_app/data_downloader.py` 中的 `get_index_list()` 方法，只保留需要的指数。

### Q4: 指数代码为什么不加市场后缀？
A: 在数据库中我们使用原始指数代码加99前缀（如 99000001, 99399001），不加 .SH 或 .SZ 后缀。下载时程序会自动添加相应的市场前缀（sh000001, sz399001）。

### Q5: 为什么要添加99前缀？
A: 因为某些指数代码与股票代码相同，例如：
- 000001 既是上证指数，也是平安银行的股票代码
- 为了避免冲突，指数存储时统一添加99前缀
- 使用 `db.get_index_data()` 方法会自动处理前缀转换

### Q6: 如何区分是指数还是股票？
A: 通过代码前缀区分：
- **99开头（8位）**：指数数据（如：99000001 = 上证指数）
- **6位数字**：股票数据（如：000001 = 平安银行，600519 = 贵州茅台）

## 示例：分析指数表现

```python
import pandas as pd
from src.stock_app.database import Database
import matplotlib.pyplot as plt

# 方法1：使用封装接口（推荐）
db = Database()

# 获取上证指数数据
df_sh = db.get_index_data('000001')
df_sh['symbol'] = '上证指数'

# 获取深证成指数据
df_sz = db.get_index_data('399001')
df_sz['symbol'] = '深证成指'

# 合并数据
df = pd.concat([df_sh, df_sz])

# 透视表
pivot_df = df.pivot(index='date', columns='symbol', values='close')
pivot_df.index = pd.to_datetime(pivot_df.index)

# 计算相对表现（归一化）
normalized = pivot_df / pivot_df.iloc[0] * 100

# 绘图
plt.figure(figsize=(12, 6))
plt.plot(normalized['000001'], label='上证指数')
plt.plot(normalized['399001'], label='深证成指')
plt.title('上证指数 vs 深证成指相对表现（基点=100）')
plt.xlabel('日期')
plt.ylabel('相对点位')
plt.legend()
plt.grid(True)
plt.show()
```

## 技术实现

下载功能基于以下组件：
- **数据源**: akshare库（`ak.stock_zh_index_daily()`）
- **存储**: SQLite数据库
- **接口**: `src/stock_app/data_downloader.py` - `DataDownloader.get_index_daily_data()`
- **数据库**: `src/stock_app/database.py` - `Database.save_index_daily_data()`
