# 对话轮数限制优化说明

## 问题描述

在运行Agent交易系统时，经常会遇到以下警告：

```
⚠️ 决策失败: 达到最大对话轮数
```

但有时到下一个决策日又能正常运行。

## 问题原因

Agent在做决策时采用多轮对话机制：
1. Agent接收市场信息和账户状态
2. Agent调用工具（查询股票数据、技术指标等）
3. Agent根据工具返回的结果继续分析
4. 重复步骤2-3，直到做出最终决策

**原问题**：
- 旧版本限制为**最多10轮对话**
- 复杂市场环境下，Agent需要查询多只股票、多个技术指标
- 容易超过10轮限制，导致决策失败
- 简单市场环境下，几轮就能完成，所以有时正常有时失败

## 解决方案

### 1. 增加对话轮数限制

将最大对话轮数从 **10轮** 增加到 **30轮**，足以应对复杂的市场分析需求。

**修改文件**: `Agents_Experience/config.py`
```python
# 对话轮数限制（Agent调用工具和最终决策的最大轮数）
MAX_CONVERSATION_ITERATIONS = 30  # 默认30轮，可根据需要调整
```

### 2. 添加详细日志

在决策过程中添加了详细的调试信息：
- 显示当前对话轮次（如：`[对话轮次 5/30] 调用API...`）
- 显示每轮工具调用数量（如：`[工具调用] 本轮调用 3 个工具`）
- 显示决策完成信息（如：`[决策完成] 在第 8 轮完成决策，共调用 12 个工具`）
- 如果达到限制，显示详细统计（如：`⚠️ 达到最大对话轮数限制（30轮），共调用了 25 个工具`）

### 3. 可自定义配置

如果30轮仍然不够（极端情况），可以在 `Agents_Experience/config.py` 中调整：

```python
MAX_CONVERSATION_ITERATIONS = 50  # 根据需要调整
```

## 效果验证

修改后，Agent能够：
- ✅ 在复杂市场环境下有足够轮数完成分析
- ✅ 通过日志清晰看到决策过程
- ✅ 减少"达到最大对话轮数"错误的发生
- ✅ 灵活调整配置以适应不同场景

## 监控建议

运行时注意观察日志：
- 如果经常在25-30轮才完成决策，建议进一步增加限制
- 如果大多数决策在10轮内完成，说明当前配置合理
- 如果频繁达到上限，可能需要优化提示词或工具使用策略

## 相关文件

- `Agents_Experience/config.py` - 配置参数
- `Agents_Experience/agents/qwen_agent.py` - Agent实现
- `Agents_Experience/logs/` - 决策日志目录
